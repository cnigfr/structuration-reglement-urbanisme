= Manuel opérateur pour la numérisation du règlement
d’urbanisme

Version du 04/03/2021


== Sommaire
 * <<Introduction>>
 * <<Etape 1. Installer les pré-requis>>
 * <<Etape 2. Copie du PLU original>>
 * <<Etape 3. Mise en page>>
 * <<Etape 4. Renseigner les métadonnées>>
 * <<Etape 5. Identifier les zones>>
 * <<Etape 6. Identifier les prescriptions>>
 * <<Etape 7. Enregistrement>>

:toc:

== Introduction

=== Contexte

Le CNIG développe actuellement un format de structuration des règlements d'urbanisme afin de les rendre plus facilement exploitables par des machines.
L'objectif à long terme de ce standard est de développer des applications pour faciliter l'instruction des demandes de permis de construire par exemple.

Afin de faciliter la transformation d'un PLU dans ce nouveau format, un outil a été créé à partir de LibreOffice. Il s'agit d'un premier outil simple pour traiter les PLU existants au format PDF.

=== Objectif

Ce manuel opérateur est destiné aux collectivités territoriales et leurs prestataires pour effectuer la numérisation de leur PLU sous LibreOffice. Il vous donnera toutes les étapes nécessaires à cette numérisation.
L’objectif de la numérisation du PLU est de créer un règlement interactif et exploitable informatiquement (au contraire d’un document au format PDF qui est figé et inexploitable informatiquement). Grâce à cette numérisation, divers projets peuvent être mis en place, notamment l’accès aux règles d’urbanisme applicables à une parcelle en lien avec le Géoportail de l’Urbanisme. D’autres applications peuvent exploiter ces données informatisées dans le but de modéliser les contraintes d’urbanisme.
La numérisation du règlement d’urbanisme repose uniquement sur des logiciels libres.


=== Exemple

Vous trouverez un exemple de PLU réalisé sous libreOffice https://github.com/cnigfr/structuration-reglement-urbanisme/blob/master/outils/Filtre_LibreOffice/exemple%20PLU_Jaleyrac.odt[ici].


== Définitions et acronymes

*Champ* : Un champ est une fonction qui permet d’ajouter du contenu dynamique au règlement écrit à structurer. Nous utilisons les champs de variable dans Writer de LibreOffice pour définir les différentes zones et prescriptions auxquelles s’applique une partie du règlement. On les trouve dans Writer de LibreOffice en effectuant Insertion/Champ/Autrechamp/Variables et comme attributs de données géographiques dans le DU dématérialisé suivant le standard CNIG.
Métadonnée : Les fiches de métadonnées sont un outil essentiel pour le catalogage des différents documents présents sur le Géoportail de l'Urbanisme, c’est une liste de données qui permet d’identifier le document vis à vis des autres documents sur GPU et d’y associer une zone géographique. C’est en quelque sorte la carte d’identité du document, permettant de le cataloguer et d’y donner accès.

*CNIG* : Conseil National de l'Information Géographique

*GPU* : Géoportail de l'Urbanisme

*PLU* : Plan Local d’Urbanisme.
Nous ne transformerons que le texte réglementaire donc nous n'aurons besoin que de la pièce Règlement écrit du GPU.

*PLUi* : PLU intercommunal. De même que pour le PLU, nous ne transformons que la pièce Règlement écrit.

*Prescription* : Une prescription se présente dans le standard CNIG PLU sous la forme d'une information surfacique, linéaire ou ponctuelle qui apparaît sur les documents graphiques du PLU. Une prescription qui se superpose à une zone du document d'urbanisme exerce en général une contrainte supplémentaire au règlement de la zone.
Pour identifier les différentes prescriptions, on peut utiliser les pièces graphiques sous forme vectorielle, dans la table des attributs de la table PRESCRIPTION, l’ensemble des prescriptions sont renseignées dans la colonne "libellé" des différentes couches (prescription de surfaciques, linéaires et ponctuelles).

*Zone* : Les zones d’un PLU(i) ou le zonage correspondent aux différentes zones d’urbanisation, et des règles différentes s’appliquent à ses différentes zones. Pour identifier les différentes zones, on utilise les pièces graphiques sous forme vectorielle, dans la table des attributs, l’ensemble des zones sont renseignées dans la colonne "libellé" de la couche des zonages.

*Style* : Les styles de LibreOffice Writer définissent les caractéristiques de mise en forme des éléments qui composent le document LibreOffice. Nous nous en servons pour définir la hiérarchie du document. 
Pour le contenu du paragraphe, on utilise le style “Corps du texte”. Ci-dessous, nous pouvons voir la table des styles qui contient les styles qui vont nous intéresser : les styles Titre numérotés, et le style corps du texte.

image::images/styles.png[align=center]

*Titre* : Un titre est défini par un style. On les utilise pour hiérarchiser le document, on utilise uniquement les titres numérotés définis par défaut dans LibreOffice. Le Titre 1, par exemple, correspond au titre d’un chapitre du règlement écrit (ex : “Chapitre 1 : Dispositions communes à toutes les zones).


== Etape 1. Installer les pré-requis

* Lecteur pdf : Vous devez avoir un lecteur de fichier PDF sur votre ordinateur (Adobe Acrobat Reader, Foxit Reader...)

* Logiciel Libre Office Writer.
Installer la dernière version de LibreOffice Writer disponible sur le site de https://www.libreoffice.org/download/download[LibreOffice].

Si vous avez une ancienne version, il est conseillé de la mettre à jour.

Note : L'outil n'a pas été testé sur des versions antérieures à LibreOffice 5.3.

* QGIS
Il peut être nécessaire d'installer QGIS afin de visualiser les prescriptions et de récupérer l'information des types/sous-type dans les fichiers du GPU.
Dans ce cas, vous pouvez télécharger et installer https://www.qgis.org/fr/site/forusers/download.html[QGIS] (l'installateur indépendant suffit).

=== Extension Libre Office
Avant de commencer, il est nécessaire d'installer le filtre LibreOffice disponible https://github.com/cnigfr/structuration-reglement-urbanisme/blob/master/outils/Filtre_LibreOffice/CNIG%20reglePLU%20v1.0.jar[ici].

Après avoir téléchargé le fichier "CNIG reglePLU v1.0.jar", suivez les étapes suivantes :

. Ouvez LibreOffice Writer
.. Aller dans le Menu Outils > (Macros) > Paramétrage des filtres XML
... Cliquer sur Ouvrir un Package et sélectionner le fichier "CNIG reglePLU v1.0.jar" sur votre disque dur
..... Fermer

Normalement, le filtre doit maintenant s'afficher dans la liste des filtres XML :

image::images/filtre.png[align=center]

=== Fichier modèle LibreOffice
La saisie du PLU doit se faire non pas dans un fichier LibreOffice vierge, mais dans le template disponible https://github.com/cnigfr/structuration-reglement-urbanisme/blob/master/outils/Filtre_LibreOffice/template%20reglePLU.odt[ici]

== Etape 2. Copie du PLU original

Si possible, demandez préalablement le règlement écrit sous forme éditable au prestataire et/ou au service urbanisme.
Il y a deux cas possible :

* Soit le règlement du PLU(i) est un document scanné page par page, dont le contenu ne peut pas être sélectionné :
Recopiez entièrement le règlement dans le fichier template FODT2CNIG.
Vous pouvez utiliser l’outil de reconnaissance de caractère (ou OCR), cela convertira l’image en texte. Il existe de nombreux outils en ligne gratuits. Un
exemple d’outil en ligne : https://www.onlineocr.net/fr/
* Soit le règlement du PLU(i) est disponible en fichier PDF, dont le contenu
peut être sélectionné :
. Sélectionner l’intégralité du PDF (Ctrl+A) et le copier (Ctrl+C).
.. Ouvrez le fichier template "template%20reglePLU.odt" sous LibreOffice
... Coller le texte du PDF au format texte brut (La mise en page ne doit surtout pas être copiée) dans le fichier FODT2CNIG de Libre Office (Edition → Collage spécial → Coller le texte non-formaté)
En effet, la mise en page originale va empêcher la conversion au format CNIG.
.... Supprimer les éléments du règlement qui sont inutiles ou qui n’ont pas de valeur réglementaire :

* Les en-têtes et pieds-de-page qui vont être répétés à chaque page.
* Les illustrations et textes "décoratifs" et qui n’ont pas valeur réglementaire.
* Il est également possible que des sauts de lignes aient été rajoutés lors de la copie. Il est souhaitable de supprimer ces sauts de lignes indésirables.

WARNING: Bien vérifier que tout soit copié dans l’ordre, selon la mise en page initiale il peut y avoir des bugs ! Notamment lorsque le texte est en deux colonnes dans le fichier au format PDF du PLU
Exemple : Quand une partie du règlement écrit est rédigée en deux blocs (partie de droite dans l'image ci-dessous), il peut y avoir des bugs au niveau des titres/sous-titres, ou encore au niveau du changement de bloc; les informations reportées dans le document LibreOffice sont alors en désordre (partie de gauche dans l'image ci-dessous).

image::images/ex1.png[align=center]

=== Copie des images

Il faut maintenant réintégrer les images souhaitées dans le texte car elle n'auront pas été copiées.
Pour cela :
. Créez un dossier nommé "ressources" dans lequel seront stockées toutes les images. Ce dossier doit être situé dans le même dossier que votre fichier LibreOffice.
.. Dans le PDF, sélectionner chaque image que vous souhaitez exporter et l'enregistrer sur le disque dur. Si ce n'est pas possible directement depuis le PDF, essayez de retrouver l'image d'origine en contactant la personne qui a réalisé le PDF, sinon effectuer une capture d'écran. Attention, la capture d'écran doit être réalisée avec un affichage supérieur ou égal à 100%, sinon l'image ne sera pas d'assez bonne qualité.
Il est conseillé d'enregistrer vos images avec un nom simple et compréhensible (par exemple image1 ou limite_propriete) afin de pouvoir les retrouver par la suite.

... Puis, insérer l'image dans LibreOffice à l'endroit souhaité (glisser-déposer dans Libre Office)
.... Enfin, modifier les propriétés de l'image afin de lui donner le même nom que le fichier image. Pour cela, effectuer un clic droit sur l'image dans Libre Office et cliquer sur Propriétés. 
Dans l'onglet Options, le champ Nom, indiquez le nom du fichier que vous venez d'enregistrer *avec l'extension : par exemple, image1.jpg ou procedure.png)*. Vous pouvez également renseigner le champ Alternative qui servira a afficher un libellé sur l'image lorsque l'on passera la souris dessus (propriété Alt en HTML).

WARNING: Ne pas oublier l'extension, sinon l'image ne s'affichera pas dans le XML.

image::images/image.png[align=center]

== Etape 3. Mise en page

Il convient maintenant de faire une mise en page sommaire. Il ne s'agit pas de recréer exactement la même mise en page que le PDF. En effet,
le format CNIG reglePLU ne prend en charge qu'un nombre limité d'options.
Les options prises en charge sont les suivantes :

* Titres
* Images
* gras
* souligné
* italique
* hyperliens
* tableaux

WARNING: Toutes les autres options de mise en page possible dans LibreOffice sont à exclure (ex : couleur de la police, colonnes, insertion de formes...).

=== Titres

Pour définir un titre, vous pouvez soit
* cliquez sur le texte du titre et sélectionner le style approprié dans la liste déroulante des styles rapides en haut à gauche de l'écran :
image::images/majS.png[align=center]

* aller dans le menu "Styles" puis Gérer les styles (ou Alt+F11) afin d'afficher le panneau latéral des styles. Il vous suffira ensuite simplement de cliquer sur une ligne et de sélectionner un style dans le panneau latéral.

Voici un exemple d’ordre de gestion des styles :
[cols=2]
|===
|Partie
|Style choisi
|Chapitre
|Titre 1
|Zone
|Titre 2
|Paragraphe 1.1 ou 1)
|Titre 3
|Sous paragraphe 1.1.1 ou Article XX-i
(ex: Article UC-3 correspondant à la
zone UC)
|Titre 4
|Sous partie du sous paragraphe ou de l’article
|Titre 5
|===

Le choix du style des titres va du général au particulier.


WARNING: Votre document doit impérativement commencer par un titre de niveau 1 (style = Titre 1 sous libre office) et il ne doit pas y avoir de trou dans l'enchaînement des titres. Par exemple, Si, sous un titre de niveau 2, il doit obligatoirement y avoir un titre de niveau 3, etc.*

=== hyperliens 

Dans Libre Office, sélectionner le texte contenant l'hyperlien et sélectionner Insérsion/Hyperlien dans le menu (ou Ctrl+K).

* S'il s'agit d'une URL externe, copier-coller l'URL dans le champ URL
* S'il s'agit d'un lien interne (pour faire un renvoi), sélectionner Document/Cible et sélectionner le titre correspondant.

== Etape 4. Renseigner les métadonnées

Le fichier template FODT2CNIG est pré-enregistré avec des métadonnées.

Pour les modifier, aller dans Fichier/Propriétés/propriétés personnalisées, et renseignez les valeurs suivantes :

* id : URL du règlement en ligne ou, sinon, le nom du règlement (pièce écrite du standard CNIG PLU). Ex : 44712_reglement_20041103
* nom : nom du règlement d’urbanisme. Le nom doit être explicite et mentionner le nom de la collectivité. Ex : Règlement écrit du PLUi de Lille Métropole
* typeDoc : Correspond au champ TYPEDOC de la classe DOC_URBA du Standard CNIG PLU. Limité aux valeurs PLU et PLUI.
* lien : lien vers le fichier de métadonnées du document d’urbanisme. Si le fichier de métadonnées est disponible en-ligne, mettre le lien de la fiche de métadonnées, sinon, le lien vers le document d’urbanisme téléchargeable sur le GPU. Ex : http://www.geoportail-urbanisme.gouv.fr/atom/datasetfeed/DU_44183.xml

Important : afin de voir les variables qui vont être ajoutées par la suite, il est important de changer l'affichage des champs.
Dans Libre Office, aller dans le menu Affichage et cliquer sur Nom des champs (ou Ctrl+F9). 
Attention : une fois cette modification effectuée, elle modifiera également l'affichage de tous vos autres document office (par exemple, les renvois ou numéros de page ne s'afficheront pas correctement). Il suffit alors de refaire la même opération pour revenir à l'affichage normal (ou Ctrl+F9).

== Etape 5. Identifier les zones

Lorsqu'un PLU est chargé dans le géoportail de l'urbanisme (GPU), il est accompagné d'une couche SIG ZONE_URBA définissant les frontières du
zonage du PLU. Ce zonage correspond dans le règlement écrit à des chapitres voir à des paragraphes spécifiques. Il convient de les identifier
à l'aide de l'outil Libre Office.

=== Dans les titres

Lorsqu'un zonage est commun à toutes les parties d'un chapitre :
Dans ce cas, cliquez à la fin du titre concerné (juste après le dernier caractère du titre, dans la même ligne) et ajouter une variable :
Insertion/Champs/Autres champs. Sélectionner la variable "idZone" et renseigner la Valeur de la façon suivante :

LIBELLE de la classe ZONE_URBA du standard CNIG PLU  correspondant à la zone décrite dans ce chapitre, ou la valeur « porteeGenerale » si le titre s’applique à toutes les zones.
La valeur peut contenir plusieurs zones séparées par des virgules. Ex :	"UG,1AU" ou "A,N".

L'identification de la commune est également nécessaire pour le bon fonctionnement de l'outil.
Pour cela, cliquez à la fin du titre concerné (après la variable "idZone" que vous venez d'ajouter) et ajouter une variable :

Insertion/Champs/Autres champs. Sélectionner la variable "inseeCommune" et renseigner le code INSEE de la commune concernée. Si plusieurs communes sont concernées, les codes INSEE séparés par une virgule. Ex: "69382,69383".

Remarque : il n'est pas nécessaire de définir une variable pour tous les titres. En effet, si la valeur est la même pour tous les sous-titres d'un titre, alors
ne la définir que pour le titre de plus haut niveau.

=== Dans les paragraphes

Lorsqu'un paragraphe concerne un zonage spécifique différent du reste du chapitre, par exemple, le secteur UGa de la zone UG.

Dans ce cas, cliquer au début du paragraphe concerné (juste avant le premier caractère du paragraphe, dans la même ligne) et ajouter une variable :
Insertion/Champs/Autres champs. Sélectionner la variable "idZoneStart" et renseigner la Valeur de la zone ou du secteur de zone concerné.

Note, cette valeur doit également correspondre à un LIBELLE de la classe ZONE_URBA.

Puis, cliquer à la fin du paragraphe concerné (juste après le dernier caractère du paragraphe, dans la même ligne) et ajouter une variable :
Insertion/Champs/Autres champs. Sélectionner la variable "idZoneEnd" et renseigner la Valeur de la zone ou du secteur de zone concerné.

Remarque : si aucune variable n'est définie à un paragraphe, alors celui-ci portera les mêmes informations que le titre auquel il appartient. Dans l'exemple précédent : UG.

== Etape 6. Identifier les prescriptions

=== Dans les titres

Lorsqu'une prescription est commune à toutes les parties d'un chapitre :
Dans ce cas, cliquez à la fin du titre concerné (juste après le dernier caractère du titre, dans la même ligne) et ajouter une variable :
Insertion/Champs/Autres champs. Sélectionner la variable "idPresc" et renseigner un identifiant de la prescription correspondant au libellé d'un objet d'une des couches PRESCRIPTION_PCT, PRESCRIPTION_SURF et PRESCRIPTION_LIN. Ex : "Mur et haie à protéger"

La valeur peut contenir plusieurs prescriptions séparées par des virgules. Ex : "Mur et haie à protéger,Continuité écologique linéaire".


Note : Dans la version définitive, il s'agira d'un nouveau champ à ajouter dans les couches PRESCRIPTION_PCT, PRESCRIPTION_SURF et PRESCRIPTION_LIN. En effet, actuellement aucun champ des tables PRESCRIPTION_XXX ne permet d'être utilisé comme identifiant.

Si le chapitre ne contient pas de prescription, alors ne pas mettre de variable idPresc.

Si le chapitre est commun à toutes les prescriptions, alors la variable "idPresc" doit avoir pour valeur "porteeGenerale".

=== Dans les paragraphes

Lorsqu'un paragraphe concerne une prescription spécifique différent du reste du chapitre :
Dans ce cas, cliquer au début du paragraphe concerné (juste avant le premier caractère du paragraphe, dans la même ligne) et ajouter une variable :
Insertion/Champs/Autres champs. Sélectionner la variable "idPrescStart" et renseigner l'identifiant de la prescription comme pour les titres (paragraphe ci-dessus).

Ensuite, cliquer à la fin du paragraphe concerné (juste après le dernier caractère du paragraphe, dans la même ligne) et ajouter une variable :
Insertion/Champs/Autres champs. Sélectionner la variable "idPrescEnd" et renseigner l'identifiant de la prescription.

Remarque : si aucune variable n'est définie à un paragraphe, alors celui-ci portera les mêmes informations que le titre auquel il appartient. Par exemple : "porteeGenerale"



== Etape 7. Enregistrement

Une fois le fichier terminé, vous pouvez l'enregistrer (en conservant le format fodt), le zipper avec le dossier ressources contenant les images et l'envoyer à stephane.garcia@ign.fr.

N'oubliez pas de remonter les problèmes rencontrés en créant des "issues" dans GitHub (https://docs.github.com/en/github/managing-your-work-on-github/creating-an-issue). Ce n'est pas la peine de le faire dans le corps du mail.


== Test (facultatif)
Pour les utilisateurs avancés :
Vous pouvez vous-même tester si le résultat est compatible avec le schéma CNIG règlement DU.
Pour cela, lancer dans l'ordre les processus XSL fodt2CNIG-1, 2 et 3 sur le fichier FODT ainsi créé et comparer le résultat avec le schéma XSD situé ici :  https://github.com/cnigfr/structuration-reglement-urbanisme/blob/master/schemas/reglementDU.xsd

Vous pouvez alors remonter les éventuelles erreurs en créant des "issues" dans GitHub.
